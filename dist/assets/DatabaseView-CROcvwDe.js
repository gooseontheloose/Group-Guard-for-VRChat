import{u as T,r as i,j as e,N as h,G as p,M as W}from"./index-CTtjqtkG.js";const O=()=>{const{selectedGroup:n}=T(),[s,v]=i.useState([]),[u,b]=i.useState(!1),[x,w]=i.useState(null),[g,S]=i.useState([]),[I,C]=i.useState(!1),[l,m]=i.useState(null),[k,f]=i.useState(!1),y=i.useCallback(async()=>{b(!0);try{const t=n?.id,r=await window.electron.database.getSessions(t);v(r),w(null),S([]),m(null)}catch(t){console.error("Failed to load sessions",t)}finally{b(!1)}},[n]);i.useEffect(()=>{y()},[y]),i.useEffect(()=>{const t=async()=>{const c=(await Promise.all(s.map(async o=>{if(!o.worldName||o.worldName==="Unknown World"){const a=o.worldId||o.location.split(":")[0];if(a&&a.startsWith("wrld_"))try{const d=await window.electron.getWorld(a);if(d.success&&d.world?.name)return{sessionId:o.sessionId,name:d.world.name}}catch(d){console.error("Failed to fetch world name for",a,d)}}return null}))).filter(o=>o!==null);c.length>0&&v(o=>o.map(a=>{const d=c.find(z=>z.sessionId===a.sessionId);return d?{...a,worldName:d.name}:a}))};s.length>0&&t()},[s]);const A=async t=>{w(t),C(!0),m(null);try{const r=await window.electron.database.getSessionEvents(t.filename);S(r||[])}catch(r){console.error("Failed to load events",r)}finally{C(!1)}},D=i.useMemo(()=>{const t={};return g.forEach(r=>{const c=r.actorDisplayName||"Unknown";t[c]=(t[c]||0)+1}),Object.entries(t).sort((r,c)=>c[1]-r[1])},[g]),j=i.useMemo(()=>l?g.filter(t=>t.actorDisplayName===l):g,[g,l]),E=()=>{f(!0)},N=async()=>{await window.electron.database.clearSessions()&&y(),f(!1)};return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"minmax(300px, 1fr) 2fr",gap:"1.5rem",height:"100%",paddingBottom:"100px"},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[e.jsxs("div",{style:{marginBottom:"1rem",display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-gradient",children:"Instance Database"}),e.jsx("div",{style:{fontSize:"0.8rem",color:"var(--color-text-dim)"},children:n?`Viewing logs for ${n.name}`:"Viewing all local logs"})]}),e.jsx(h,{size:"sm",variant:"danger",onClick:E,style:{fontSize:"0.7rem"},children:"Clear DB"})]}),e.jsxs(p,{style:{flex:1,display:"flex",flexDirection:"column",padding:0,overflow:"hidden"},children:[e.jsxs("div",{style:{padding:"1rem",borderBottom:"1px solid rgba(255,255,255,0.1)",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("span",{style:{fontWeight:600},children:["Sessions (",s.length,")"]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:y,disabled:u,children:u?"...":"âŸ³"})]}),e.jsxs("div",{style:{flex:1,overflowY:"auto"},children:[s.length===0&&!u&&e.jsx("div",{style:{padding:"2rem",textAlign:"center",color:"rgba(255,255,255,0.3)"},children:"No logs found for this group."}),s.map(t=>e.jsxs("div",{onClick:()=>A(t),style:{padding:"1rem",borderBottom:"1px solid rgba(255,255,255,0.05)",cursor:"pointer",background:x?.sessionId===t.sessionId?"rgba(var(--color-primary-rgb), 0.1)":"transparent",borderLeft:x?.sessionId===t.sessionId?"3px solid var(--color-primary)":"3px solid transparent",transition:"background 0.2s"},children:[e.jsx("div",{style:{fontSize:"0.9rem",fontWeight:600,color:"white",marginBottom:"4px"},children:t.worldName||"Unknown World"}),e.jsxs("div",{style:{fontSize:"0.75rem",color:"rgba(255,255,255,0.5)",display:"flex",justifyContent:"space-between"},children:[e.jsx("span",{children:new Date(t.startTime).toLocaleString()}),t.groupId&&e.jsx("span",{style:{color:"var(--color-accent)"},children:"GRP"})]}),e.jsx("div",{style:{fontSize:"0.7rem",color:"rgba(255,255,255,0.3)",marginTop:"4px",fontFamily:"monospace",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:t.instanceId})]},t.sessionId))]})]})]}),e.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:x?e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1rem",height:"100%"},children:[e.jsx(p,{children:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[e.jsxs("div",{children:[e.jsx("h3",{style:{margin:0},children:x.worldName||x.worldId}),e.jsx("div",{style:{color:"var(--color-text-dim)",fontSize:"0.9rem",marginTop:"0.5rem"},children:new Date(x.startTime).toLocaleString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})})]}),e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx("div",{style:{fontSize:"2rem",fontWeight:"bold",color:"var(--color-primary)",lineHeight:1},children:j.length}),e.jsx("div",{style:{fontSize:"0.7rem",textTransform:"uppercase",letterSpacing:"1px"},children:l?`Events by ${l}`:"Total Events"}),l&&e.jsx(h,{size:"sm",variant:"ghost",style:{marginTop:"4px",fontSize:"0.7rem",padding:"2px 8px"},onClick:()=>m(null),children:"Clear Filter"})]})]})}),e.jsxs("div",{style:{flex:1,display:"grid",gridTemplateColumns:"2fr 1fr",gap:"1rem",minHeight:0},children:[e.jsxs(p,{style:{display:"flex",flexDirection:"column",padding:0,overflow:"hidden"},children:[e.jsx("div",{style:{padding:"0.8rem",borderBottom:"1px solid rgba(255,255,255,0.1)",background:"rgba(0,0,0,0.2)",fontWeight:600,fontSize:"0.9rem"},children:l?`Activity: ${l}`:"Full Activity Log"}),e.jsx("div",{style:{flex:1,overflowY:"auto"},children:I?e.jsx("div",{style:{padding:"2rem",textAlign:"center"},children:"Loading events..."}):e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse",fontSize:"0.85rem"},children:[e.jsx("thead",{style:{background:"rgba(255,255,255,0.05)",color:"var(--color-text-dim)",textAlign:"left"},children:e.jsxs("tr",{children:[e.jsx("th",{style:{padding:"0.8rem"},children:"Time"}),e.jsx("th",{style:{padding:"0.8rem"},children:"Type"}),e.jsx("th",{style:{padding:"0.8rem"},children:"User"}),e.jsx("th",{style:{padding:"0.8rem"},children:"Details"})]})}),e.jsx("tbody",{children:j.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,style:{padding:"1rem",textAlign:"center",color:"gray"},children:"No events found"})}):j.map((t,r)=>e.jsxs("tr",{style:{borderBottom:"1px solid rgba(255,255,255,0.02)"},children:[e.jsx("td",{style:{padding:"0.6rem 0.8rem",color:"rgba(255,255,255,0.5)",whiteSpace:"nowrap"},children:new Date(t.timestamp).toLocaleTimeString([],{hour12:!1})}),e.jsx("td",{style:{padding:"0.6rem 0.8rem"},children:e.jsx(B,{type:t.type})}),e.jsx("td",{style:{padding:"0.6rem 0.8rem",fontWeight:500},children:t.actorDisplayName}),e.jsx("td",{style:{padding:"0.6rem 0.8rem",color:"rgba(255,255,255,0.6)",maxWidth:"200px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:JSON.stringify(t.details||"")})]},r))})]})})]}),e.jsxs(p,{style:{display:"flex",flexDirection:"column",padding:0,overflow:"hidden"},children:[e.jsx("div",{style:{padding:"0.8rem",borderBottom:"1px solid rgba(255,255,255,0.1)",background:"rgba(0,0,0,0.2)",fontWeight:600,fontSize:"0.9rem"},children:"Participants"}),e.jsx("div",{style:{flex:1,overflowY:"auto",padding:"0.5rem"},children:D.map(([t,r])=>e.jsxs("div",{onClick:()=>m(t===l?null:t),style:{display:"flex",justifyContent:"space-between",padding:"0.5rem",borderBottom:"1px solid rgba(255,255,255,0.02)",cursor:"pointer",background:l===t?"rgba(var(--color-primary-rgb), 0.2)":"transparent",borderRadius:"6px",transition:"background 0.2s"},children:[e.jsx("span",{style:{fontSize:"0.9rem",color:l===t?"white":"inherit"},children:t}),e.jsx("span",{style:{fontSize:"0.8rem",background:"rgba(255,255,255,0.1)",borderRadius:"10px",padding:"0 6px"},children:r})]},t))})]})]})]}):e.jsxs(p,{style:{height:"100%",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column"},children:[e.jsx("div",{style:{fontSize:"3rem",opacity:.2},children:"ðŸ“‚"}),e.jsx("div",{style:{marginTop:"1rem",color:"var(--color-text-dim)"},children:"Select a session to view details"})]})}),e.jsx(W,{isOpen:k,onClose:()=>f(!1),title:"Clear Database",width:"400px",footer:e.jsxs(e.Fragment,{children:[e.jsx(h,{variant:"ghost",onClick:()=>f(!1),children:"Cancel"}),e.jsx(h,{variant:"danger",onClick:N,glow:!0,children:"Yes, Clear Everything"})]}),children:e.jsxs("div",{style:{color:"var(--color-text-secondary)",lineHeight:"1.6"},children:["Are you sure you want to clear the entire instance database?",e.jsx("br",{}),e.jsx("br",{}),e.jsx("span",{style:{color:"#ef4444",fontWeight:500},children:"This cannot be undone."}),e.jsx("br",{}),"All logged sessions and event history will be permanently deleted.",e.jsx("br",{}),e.jsx("br",{}),e.jsx("span",{style:{fontSize:"0.85rem",color:"var(--color-text-dim)",fontStyle:"italic"},children:"Note: If you are currently playing VRChat, you will need to rejoin the world to begin populating the new database."})]})})]})},B=({type:n})=>{if(!n)return e.jsx("span",{style:{color:"gray"},children:"Unknown"});let s="gray";return n==="JOIN"&&(s="#22c55e"),n==="LEAVE"&&(s="#ef4444"),n==="AVATAR_CHANGE"&&(s="#3b82f6"),n==="WORLD_NAME_UPDATE"&&(s="#eab308"),n==="LOCATION_CHANGE"&&(s="#8b5cf6"),e.jsx("span",{style:{color:s,background:`${s}20`,padding:"2px 6px",borderRadius:"4px",fontSize:"0.7rem",fontWeight:700},children:n.replace("_"," ")})};export{O as DatabaseView};
