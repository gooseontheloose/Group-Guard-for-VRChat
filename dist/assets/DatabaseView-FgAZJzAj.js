import{u as M,b as _,r as n,j as e,N as f,G as j,M as A}from"./index-D5E0sjoJ.js";const $=`
@keyframes progressPulse {
    0% { width: 10%; margin-left: 0%; }
    50% { width: 40%; margin-left: 30%; }
    100% { width: 10%; margin-left: 90%; }
}
`,q=()=>{const{selectedGroup:i}=M(),{openProfile:a}=_(),[m,k]=n.useState([]),[C,z]=n.useState(!1),[o,R]=n.useState(null),[u,D]=n.useState([]),[U,E]=n.useState(!1),[l,v]=n.useState(null),[W,b]=n.useState(!1),[O,w]=n.useState(!1),[y,N]=n.useState(!1),[s,p]=n.useState(null),[h,T]=n.useState(null);n.useEffect(()=>{const r=window.electron.database.onRallyProgress(t=>{t.done?T(null):T({sent:t.sent,failed:t.failed,total:t.total})});return()=>r()},[]);const S=n.useCallback(async()=>{z(!0);try{const r=i?.id,t=await window.electron.database.getSessions(r);k(t),R(null),D([]),v(null)}catch(r){console.error("Failed to load sessions",r)}finally{z(!1)}},[i]);n.useEffect(()=>{S()},[S]),n.useEffect(()=>{const r=async()=>{const d=(await Promise.all(m.map(async c=>{if(!c.worldName||c.worldName==="Unknown World"){const g=c.worldId||c.location.split(":")[0];if(g&&g.startsWith("wrld_"))try{const x=await window.electron.getWorld(g);if(x.success&&x.world?.name)return{sessionId:c.sessionId,name:x.world.name}}catch(x){console.error("Failed to fetch world name for",g,x)}}return null}))).filter(c=>c!==null);d.length>0&&k(c=>c.map(g=>{const x=d.find(G=>G.sessionId===g.sessionId);return x?{...g,worldName:x.name}:g}))};m.length>0&&r()},[m]);const P=async r=>{R(r),E(!0),v(null);try{const t=await window.electron.database.getSessionEvents(r.sessionId);D(t||[])}catch(t){console.error("Failed to load events",t)}finally{E(!1)}},B=n.useMemo(()=>{const r={};return u.forEach(t=>{const d=t.actorDisplayName||"Unknown";r[d]=(r[d]||0)+1}),Object.entries(r).sort((t,d)=>d[1]-t[1])},[u]),I=n.useMemo(()=>l?u.filter(r=>r.actorDisplayName===l):u,[u,l]),F=()=>{b(!0)},L=async()=>{await window.electron.database.clearSessions()&&S(),b(!1)},H=()=>{o&&(p(null),w(!0))},V=async()=>{if(o){w(!1),N(!0),p(null);try{const r=await window.electron.database.rallyFromSession(o.sessionId);p(r)}catch(r){p({error:r.message||"Unknown error"})}finally{N(!1)}}};return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:$}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"minmax(300px, 1fr) 2fr",gap:"1.5rem",height:"100%",paddingBottom:"100px"},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[e.jsxs("div",{style:{marginBottom:"1rem",display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-gradient",children:"Instance Database"}),e.jsx("div",{style:{fontSize:"0.8rem",color:"var(--color-text-dim)"},children:i?`Viewing logs for ${i.name}`:"Viewing all local logs"})]}),e.jsx(f,{size:"sm",variant:"danger",onClick:F,style:{fontSize:"0.7rem"},children:"Clear DB"})]}),e.jsxs(j,{style:{flex:1,display:"flex",flexDirection:"column",padding:0,overflow:"hidden"},children:[e.jsxs("div",{style:{padding:"1rem",borderBottom:"1px solid rgba(255,255,255,0.1)",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("span",{style:{fontWeight:600},children:["Sessions (",m.length,")"]}),e.jsx(f,{size:"sm",variant:"ghost",onClick:S,disabled:C,children:C?"...":"âŸ³"})]}),e.jsxs("div",{style:{flex:1,overflowY:"auto"},children:[m.length===0&&!C&&e.jsx("div",{style:{padding:"2rem",textAlign:"center",color:"rgba(255,255,255,0.3)"},children:"No logs found for this group."}),m.map(r=>e.jsxs("div",{onClick:()=>P(r),style:{padding:"1rem",borderBottom:"1px solid rgba(255,255,255,0.05)",cursor:"pointer",background:o?.sessionId===r.sessionId?"rgba(var(--color-primary-rgb), 0.1)":"transparent",borderLeft:o?.sessionId===r.sessionId?"3px solid var(--color-primary)":"3px solid transparent",transition:"background 0.2s"},children:[e.jsx("div",{style:{fontSize:"0.9rem",fontWeight:600,color:"white",marginBottom:"4px"},children:r.worldName||"Unknown World"}),e.jsxs("div",{style:{fontSize:"0.75rem",color:"rgba(255,255,255,0.5)",display:"flex",justifyContent:"space-between"},children:[e.jsx("span",{children:new Date(r.startTime).toLocaleString()}),r.groupId&&e.jsx("span",{style:{color:"var(--color-accent)"},children:"GRP"})]}),e.jsx("div",{style:{fontSize:"0.7rem",color:"rgba(255,255,255,0.3)",marginTop:"4px",fontFamily:"monospace",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:r.instanceId})]},r.sessionId))]})]})]}),e.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:o?e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1rem",height:"100%"},children:[e.jsxs(j,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[e.jsxs("div",{children:[e.jsx("h3",{style:{margin:0},children:o.worldName||o.worldId}),e.jsx("div",{style:{color:"var(--color-text-dim)",fontSize:"0.9rem",marginTop:"0.5rem"},children:new Date(o.startTime).toLocaleString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})})]}),e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx("div",{style:{fontSize:"2rem",fontWeight:"bold",color:"var(--color-primary)",lineHeight:1},children:I.length}),e.jsx("div",{style:{fontSize:"0.7rem",textTransform:"uppercase",letterSpacing:"1px"},children:l?`Events by ${l}`:"Total Events"}),l&&e.jsx(f,{size:"sm",variant:"ghost",style:{marginTop:"4px",fontSize:"0.7rem",padding:"2px 8px"},onClick:()=>v(null),children:"Clear Filter"})]})]}),e.jsxs("div",{style:{marginTop:"1rem",paddingTop:"1rem",borderTop:"1px solid rgba(255,255,255,0.1)",display:"flex",alignItems:"center",gap:"1rem"},children:[e.jsx(f,{size:"sm",variant:"primary",onClick:H,disabled:y,glow:!0,children:y?"ðŸ“¡ Sending Invites...":"ðŸ“£ Rally Users Here"}),y&&h?e.jsxs("div",{style:{flex:1,display:"flex",alignItems:"center",gap:"0.75rem"},children:[e.jsx("div",{style:{flex:1,height:"8px",background:"rgba(255,255,255,0.1)",borderRadius:"4px",overflow:"hidden"},children:e.jsx("div",{style:{width:`${Math.round(h.sent/h.total*100)}%`,height:"100%",background:h.failed>0?"linear-gradient(90deg, var(--color-primary), #f59e0b)":"var(--color-primary)",borderRadius:"4px",transition:"width 0.3s ease"}})}),e.jsxs("span",{style:{fontSize:"0.85rem",color:"white",fontWeight:600,fontFamily:"monospace",minWidth:"80px"},children:["âœ“ ",h.sent,"/",h.total,h.failed>0&&e.jsxs("span",{style:{color:"#f59e0b"},children:[" (",h.failed," âœ—)"]})]})]}):y?e.jsx("span",{style:{fontSize:"0.8rem",color:"var(--color-text-dim)"},children:"Preparing invites..."}):s?e.jsxs("div",{style:{fontSize:"0.85rem",padding:"4px 10px",borderRadius:"6px",background:s.error?"rgba(239, 68, 68, 0.15)":"rgba(34, 197, 94, 0.15)",color:s.error?"#ef4444":"#22c55e",display:"flex",alignItems:"center",gap:"0.5rem"},children:[s.error?e.jsxs(e.Fragment,{children:["âŒ ",s.error]}):e.jsxs(e.Fragment,{children:["âœ“ Sent ",s.invited," invite",s.invited!==1?"s":""]}),e.jsx("button",{onClick:()=>p(null),style:{background:"none",border:"none",color:"inherit",cursor:"pointer",fontSize:"1rem",lineHeight:1,opacity:.6},children:"Ã—"})]}):e.jsx("span",{style:{fontSize:"0.8rem",color:"var(--color-text-dim)"},children:"Invite all users from this session"})]})]}),e.jsxs("div",{style:{flex:1,display:"grid",gridTemplateColumns:"2fr 1fr",gap:"1rem",minHeight:0},children:[e.jsxs(j,{style:{display:"flex",flexDirection:"column",padding:0,overflow:"hidden"},children:[e.jsx("div",{style:{padding:"0.8rem",borderBottom:"1px solid rgba(255,255,255,0.1)",background:"rgba(0,0,0,0.2)",fontWeight:600,fontSize:"0.9rem"},children:l?`Activity: ${l}`:"Full Activity Log"}),e.jsx("div",{style:{flex:1,overflowY:"auto"},children:U?e.jsx("div",{style:{padding:"2rem",textAlign:"center"},children:"Loading events..."}):e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse",fontSize:"0.85rem"},children:[e.jsx("thead",{style:{background:"rgba(255,255,255,0.05)",color:"var(--color-text-dim)",textAlign:"left"},children:e.jsxs("tr",{children:[e.jsx("th",{style:{padding:"0.8rem"},children:"Time"}),e.jsx("th",{style:{padding:"0.8rem"},children:"Type"}),e.jsx("th",{style:{padding:"0.8rem"},children:"User"}),e.jsx("th",{style:{padding:"0.8rem"},children:"Details"})]})}),e.jsx("tbody",{children:I.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,style:{padding:"1rem",textAlign:"center",color:"gray"},children:"No events found"})}):I.map((r,t)=>e.jsxs("tr",{style:{borderBottom:"1px solid rgba(255,255,255,0.02)"},children:[e.jsx("td",{style:{padding:"0.6rem 0.8rem",color:"rgba(255,255,255,0.5)",whiteSpace:"nowrap"},children:new Date(r.timestamp).toLocaleTimeString([],{hour12:!1})}),e.jsx("td",{style:{padding:"0.6rem 0.8rem"},children:e.jsx(Y,{type:r.type})}),e.jsx("td",{style:{padding:"0.6rem 0.8rem",fontWeight:500},children:e.jsx("span",{style:{cursor:r.actorUserId?"pointer":"default",textDecoration:r.actorUserId?"underline":"none",textDecorationColor:"rgba(255,255,255,0.3)",textUnderlineOffset:"2px"},onClick:d=>{r.actorUserId&&(d.stopPropagation(),a(r.actorUserId))},title:r.actorUserId?"View Profile":void 0,children:r.actorDisplayName})}),e.jsx("td",{style:{padding:"0.6rem 0.8rem",color:"rgba(255,255,255,0.6)",maxWidth:"200px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:JSON.stringify(r.details||"")})]},t))})]})})]}),e.jsxs(j,{style:{display:"flex",flexDirection:"column",padding:0,overflow:"hidden"},children:[e.jsx("div",{style:{padding:"0.8rem",borderBottom:"1px solid rgba(255,255,255,0.1)",background:"rgba(0,0,0,0.2)",fontWeight:600,fontSize:"0.9rem"},children:"Participants"}),e.jsx("div",{style:{flex:1,overflowY:"auto",padding:"0.5rem"},children:B.map(([r,t])=>e.jsxs("div",{onClick:()=>v(r===l?null:r),style:{display:"flex",justifyContent:"space-between",padding:"0.5rem",borderBottom:"1px solid rgba(255,255,255,0.02)",cursor:"pointer",background:l===r?"rgba(var(--color-primary-rgb), 0.2)":"transparent",borderRadius:"6px",transition:"background 0.2s"},children:[e.jsx("span",{style:{fontSize:"0.9rem",color:l===r?"white":"inherit"},children:r}),e.jsx("span",{style:{fontSize:"0.8rem",background:"rgba(255,255,255,0.1)",borderRadius:"10px",padding:"0 6px"},children:t})]},r))})]})]})]}):e.jsxs(j,{style:{height:"100%",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column"},children:[e.jsx("div",{style:{fontSize:"3rem",opacity:.2},children:"ðŸ“‚"}),e.jsx("div",{style:{marginTop:"1rem",color:"var(--color-text-dim)"},children:"Select a session to view details"})]})}),e.jsx(A,{isOpen:W,onClose:()=>b(!1),title:"Clear Database",width:"400px",footer:e.jsxs(e.Fragment,{children:[e.jsx(f,{variant:"ghost",onClick:()=>b(!1),children:"Cancel"}),e.jsx(f,{variant:"danger",onClick:L,glow:!0,children:"Yes, Clear Everything"})]}),children:e.jsxs("div",{style:{color:"var(--color-text-secondary)",lineHeight:"1.6"},children:["Are you sure you want to clear the entire instance database?",e.jsx("br",{}),e.jsx("br",{}),e.jsx("span",{style:{color:"#ef4444",fontWeight:500},children:"This cannot be undone."}),e.jsx("br",{}),"All logged sessions and event history will be permanently deleted.",e.jsx("br",{}),e.jsx("br",{}),e.jsx("span",{style:{fontSize:"0.85rem",color:"var(--color-text-dim)",fontStyle:"italic"},children:"Note: If you are currently playing VRChat, you will need to rejoin the world to begin populating the new database."})]})}),e.jsx(A,{isOpen:O,onClose:()=>{w(!1),p(null)},title:"ðŸ“£ Rally Previous Session",width:"450px",footer:e.jsxs(e.Fragment,{children:[e.jsx(f,{variant:"ghost",onClick:()=>{w(!1),p(null)},children:s?"Close":"Cancel"}),!s&&e.jsx(f,{variant:"primary",onClick:V,disabled:y,glow:!0,children:y?"Sending Invites...":"Send Invites"})]}),children:e.jsx("div",{style:{color:"var(--color-text-secondary)",lineHeight:"1.6"},children:s?s.error?e.jsxs("div",{style:{color:"#ef4444"},children:[e.jsx("strong",{children:"Error:"})," ",s.error]}):e.jsxs("div",{children:[e.jsx("div",{style:{color:"#22c55e",fontWeight:600,fontSize:"1.1rem",marginBottom:"0.5rem"},children:"âœ“ Rally Complete!"}),e.jsxs("p",{style:{margin:0},children:["Sent ",e.jsx("strong",{children:s.invited})," invite",s.invited!==1?"s":"",s.failed&&s.failed>0&&e.jsxs("span",{style:{color:"#f59e0b"},children:[" (",s.failed," failed)"]})]}),s.errors&&s.errors.length>0&&e.jsx("div",{style:{marginTop:"0.5rem",fontSize:"0.85rem",color:"#f59e0b"},children:s.errors.join(", ")})]}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{style:{margin:0},children:["This will invite all users from ",e.jsx("strong",{children:o?.worldName||"this session"})," to your current instance."]}),e.jsx("br",{}),e.jsx("span",{style:{fontSize:"0.9rem",color:"var(--color-text-dim)"},children:"Users already in your instance will be skipped. Invites are rate-limited to avoid VRChat throttling."})]})})})]})]})},Y=({type:i})=>{if(!i)return e.jsx("span",{style:{color:"gray"},children:"Unknown"});let a="gray";return i==="JOIN"&&(a="#22c55e"),i==="LEAVE"&&(a="#ef4444"),i==="AVATAR_CHANGE"&&(a="#3b82f6"),i==="WORLD_NAME_UPDATE"&&(a="#eab308"),i==="LOCATION_CHANGE"&&(a="#8b5cf6"),e.jsx("span",{style:{color:a,background:`${a}20`,padding:"2px 6px",borderRadius:"4px",fontSize:"0.7rem",fontWeight:700},children:i.replace("_"," ")})};export{q as DatabaseView};
